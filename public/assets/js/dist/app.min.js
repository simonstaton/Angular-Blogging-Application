var ss=angular.module("ss",["ngRoute","ngAnimate","ngCookies","angularFileUpload"]);ss.config(["$routeProvider","$locationProvider",function(a,b){b.hashPrefix("!"),a.when("/login",{templateUrl:"app/pages/login/login.view.html",controller:"login",label:"Login"}).when("/login/success",{redirectTo:"/dashboard",label:"Dashboard"}).when("/register",{templateUrl:"app/pages/register/register.view.html",controller:"register",label:"Register"}).otherwise({redirectTo:"/blog"}),b.html5Mode(!0)}]),ss.controller("_Base",["$scope","$location","i18n","breadcrumbs",function(a,b,c){a.page?c.set("page",a.page):c.set("page","global"),a.initialise&&a.initialise(),a.notify={}}]),ss.controller("blog",["$scope","$controller","$routeParams","api","breadcrumbs",function(a,b,c,d,e){c.slug?d.blog.getPost({slug:c.slug}).then(function(b){a.post=b.data,e.dynamicLabels={postTitle:b.data.title}},function(a){console.log(a)}):d.blog.getPosts().then(function(b){a.posts=b.data},function(a){console.log(a)}),b("_Base",{$scope:angular.extend(a,{})})}]),ss.config(["$routeProvider","$locationProvider",function(a){a.when("/blog/:slug",{templateUrl:"app/pages/blog/views/blog.single.view.html",controller:"blog",label:"postTitle"}).when("/blog",{templateUrl:"app/pages/blog/views/blog.index.view.html",controller:"blog",label:"blog"})}]),ss.controller("dashboardEditPost",["$scope","$controller","api","session","$location",function(a,b,c,d,e){var f=e.search();b("_Base",{$scope:angular.extend(a,{page:"dashboard",editting:!0,form:{_id:f._id,submitter:c.session.user._id},session:c.session,initialise:function(){a.i18n.set("store.pageTitle","Edit Post | Dashboard"),c.blog.getPost({_id:f._id}).then(function(b){a.form=b.data,a.title=a.form.title},function(){e.path("/dashboard/posts"),a.$parent.notify={state:"error",message:a.i18n.store.notifications.postNotFound,route:!0}})},submit:function(){c.dashboard.editPost(a.form).then(function(){a.$parent.notify={state:"success",message:a.i18n.store.notifications.postUpdated}},function(b){a.notify={state:"error",message:b}})}})})}]),ss.controller("dashboardPosts",["$scope","$controller","api","session","$location",function(a,b,c,d,e){b("_Base",{$scope:angular.extend(a,{page:"dashboard",session:c.session,initialise:function(){a.i18n.set("store.pageTitle","Posts | Dashboard"),c.blog.getPosts().then(function(b){a.posts=b.data})},"delete":function(b){c.dashboard.deletePost({_id:b._id}).then(function(){a.posts.splice(a.posts.indexOf(b),1),a.$parent.notify={state:"success",message:a.i18n.store.notifications.postDeleted,timeout:5e3}},function(b){a.notify={state:"error",message:b}})},edit:function(a){e.search({_id:a._id}),e.path("/dashboard/posts/edit")}})})}]),ss.controller("dashboardNewPost",["$scope","$controller","$filter","api","session",function(a,b,c,d,e){b("_Base",{$scope:angular.extend(a,{page:"dashboard",form:{submitter:d.session.user._id},session:e,initialise:function(){a.i18n.set("store.pageTitle","New Post | Dashboard")},reset:function(){this.form.title=null,this.form.description=null,this.form.slug=null},submit:function(){console.log(a.form),d.dashboard.createPost(a.form).then(function(){a.$parent.notify={state:"success",message:a.i18n.store.notifications.postCreated},a.reset()},function(b){a.notify={state:"error",message:b}})}})})}]),ss.controller("dashboard",["$scope","$controller","api","session",function(a,b,c){b("_Base",{$scope:angular.extend(a,{page:"dashboard",session:c.session})})}]),ss.config(["$routeProvider","$locationProvider",function(a){var b=["api","$location","i18n",function(a,b,c){return a.authorise().catch(function(){a.session||(b.path("/login"),$head.scope().notify={state:"error",message:c.store.notifications.pleaseLogin,route:!0})})}];a.when("/dashboard",{templateUrl:"app/pages/dashboard/dashboard.view.html",controller:"dashboard",resolve:{session:b},label:"dashboard"}).when("/dashboard/posts",{templateUrl:"app/pages/dashboard/views/post.index.view.html",controller:"dashboardPosts",resolve:{session:b},label:"view posts"}).when("/dashboard/posts/edit",{templateUrl:"app/shared/editors/views/post.editor.view.html",controller:"dashboardEditPost",resolve:{session:b},label:"edit post"}).when("/dashboard/posts/new",{templateUrl:"app/shared/editors/views/post.editor.view.html",controller:"dashboardNewPost",resolve:{session:b},label:"new post"})}]),ss.controller("footer",["$scope","$controller",function(a,b){b("_Base",{$scope:angular.extend(a,{})})}]),ss.controller("global",["$scope","$location","$rootScope","$timeout","i18n","api","breadcrumbs",function(a,b,c,d,e,f,g){f.getJson("/app/json/i18n.json").then(function(a){e.set("langPack",a.data),e.set("page","global")}),f.authorise(),angular.extend(a,{i18n:e,api:f,location:b,notify:{}}),d(function(){a.pageParsed||(a.pageParsed=!0)},500),c.$on("$routeChangeError",function(b,c,d,e){a.notify={state:"error",message:e.error}}),c.$on("$routeChangeSuccess",function(){a.notify&&!a.notify.route&&(a.notify=null)}),a.breadcrumbs=g}]),ss.controller("header",["$scope","$controller","$location","api",function(a,b,c,d){b("_Base",{$scope:angular.extend(a,{logout:function(){d.logout().then(function(){c.path("/"),a.notify={state:"success",message:a.i18n.store.notifications.loggedOut,timeout:2e3,route:!0}},function(a){console.log(a)})}})})}]),ss.controller("login",["$scope","$controller","$location","api",function(a,b,c,d){b("_Base",{$scope:angular.extend(a,{loginForm:{},initialise:function(){d.session&&c.path("/dashboard")},login:function(){d.login(a.loginForm).then(function(){a.$parent.notify={state:"success",message:a.i18n.store.notifications.loggedIn,timeout:2e3,route:!0},c.path("/login/success")},function(b){a.notify={state:"error",message:b}})}})})}]),ss.controller("register",["$scope","$controller","$location","api",function(a,b,c,d){b("_Base",{$scope:angular.extend(a,{registerForm:{},initialise:function(){d.session&&c.path("/dashboard")},register:function(){d.register(a.registerForm).then(function(){c.path("/login"),a.$parent.notify={state:"error",message:a.i18n.notifications.login,timeout:5e3}},function(b){a.$parent.notify={state:"error",message:b}})}})})}]),ss.service("api",["$http","$q","$upload","hitch",function(a,b,c,d){var e=[],f={},g=function(c){if(("PUT"==c.method||"POST"==c.method)&&(f={}),"GET"==c.method&&f[c.url]){var d=b.defer();return d.resolve(f[c.url]),d.promise}return"GET"==c.method?a(c).success(function(a){f[c.url]={data:a}}):a(c)};angular.extend(this,{dashboard:{createPost:function(a){return g({method:"POST",url:"/posts/create",data:a})},editPost:function(a){return g({method:"PUT",url:"/posts/edit",data:a})},deletePost:function(a){return g({method:"DELETE",url:"/posts/delete/"+JSON.stringify(a)})},createCategory:function(a){return g({method:"POST",url:"/categories/create",data:a})},editCategory:function(a){return g({method:"PUT",url:"/categories/edit",data:a})},deleteCategory:function(a){return g({method:"DELETE",url:"/categories/delete/"+JSON.stringify(a)})}},blog:{getPosts:function(){return g({method:"GET",url:"/posts"})},getPost:function(a){return g({method:"GET",url:"/posts/"+JSON.stringify(a)})},getCategories:function(){return g({method:"GET",url:"/categories"})},getCategory:function(a){return g({method:"GET",url:"/categories/"+JSON.stringify(a)})}},upload:{image:function(a){return c.upload({url:"/upload/image",method:"POST",file:a})},deleteFile:function(a){return g({method:"DELETE",url:"/upload/delete/"+encodeURIComponent(a)})}},getJson:function(b){return a.get(b)},logout:function(){var a=this;return g({method:"GET",url:"/auth/logout"}).then(function(){a.session=null})},login:function(a){var b=this;return g({method:"POST",url:"/auth/login",data:a}).then(function(a){b.session=a.data},function(){b.session=null})},register:function(a){return g({method:"POST",url:"/auth/register",data:a})},authorise:function(){var a=b.defer();return b.all(e).then(d(this,function(){e=[],this.session?a.resolve(this.session):g({method:"GET",url:"/auth/authorise"}).then(d(this,function(b){this.session=b.data,a.resolve(b)}),d(this,function(b){this.session=null,a.reject(b)})),e.push(a.promise)}),d(this,function(b){a.reject(b)})),a.promise}})}]),ss.factory("breadcrumbs",["$rootScope","$route","hitch",function(a,b,c){var d={breadcrumbs:[],build:function(){if(b.current&&b.current.originalPath){this.breadcrumbs=[];var a=b.current.params,d=b.current.originalPath.split("/");angular.forEach(d,c(this,function(c,e){for(var f=function(b){return":"===b[0]&&"undefined"!=typeof a[b.substring(1)]?a[b.substring(1)]:!1},g="",h="",i=0;e>=i;i++)g+=d[i],h+=f(d[i])?f(d[i]):d[i],i!==e&&(g+="/",h+="/");b.routes[g]&&(b.routes[g].label||param)&&this.breadcrumbs.push({path:h,label:b.routes[g].label||param,param:f(c)})}))}},getDynamicLabel:function(){if(this.dynamicLabels)for(var a in this.dynamicLabels)for(var b in this.breadcrumbs){var c=this.breadcrumbs[b];c.label===a&&(c.label=this.dynamicLabels[a])}return this.breadcrumbs}};return a.$on("$routeChangeSuccess",function(){d.build()}),a.$watch(function(){return d.dynamicLabels},function(){d.build()}),d.build(),d}]).directive("breadcrumbs",function(){return{restrict:"E",transclude:!0,template:'<ul class="breadcrumbs"><li ng-repeat="breadcrumb in breadcrumbs.getDynamicLabel() track by breadcrumb.path" ng-class="{ active: $last }"><a ng-if="!$last" ng-href="{{ breadcrumb.path }}" ng-bind="breadcrumb.label" class="margin-right-xs"></a> <span ng-if="!$last"> > </span><span ng-if="$last" ng-bind="breadcrumb.label"></span></li></ul>',replace:!0}}),ss.controller("categoryEditor",["$scope","$controller","$filter","api",function(a,b,c,d){a.defaultSlug||(a.defaultSlug=!0),a.form||(a.form=a.$parent.form),d.blog.getCategories().then(function(b){a.categories=b.data}),b("_Base",{$scope:angular.extend(a,{title:function(b){return angular.isDefined(b)&&(a.form.title=b,a.defaultSlug&&a.formatSlug()),a.form.title},reset:function(){this.form.title=null,this.form.description=null,this.form.slug=null},formatSlug:function(){if(angular.isDefined(a.form.title)){var b=c("limitTo")(a.form.title,30);a.form.slug=b.toLowerCase().replace(/ /g,"-").replace(/[^\w-]+/g,"")}},editSlug:function(){this.defaultSlug?this.defaultSlug=!1:(this.defaultSlug=!0,a.formatSlug())}})})}]),ss.controller("postEditor",["$scope","$element","$controller","$filter","api","hitch",function(a,b,c,d,e,f){c("_Base",{$scope:angular.extend(a,{initialise:function(){a.defaultSlug||(a.defaultSlug=!0),a.form||(a.form=a.$parent.form),e.blog.getCategories().then(function(b){a.categories=b.data}),this.$slugInput=$("#slug",b),this._bindEvents()},_bindEvents:function(){this.$slugInput.on("keyup",f(this,function(){this.$slugInput.val(this.$slugInput.val().toLowerCase().replace(/ /g,"-").replace(/[^\w-]+/g,""))}))},title:function(b){return angular.isDefined(b)&&(a.form.title=b,a.defaultSlug&&a.formatSlug()),a.form.title},reset:function(){this.form.title=null,this.form.description=null,this.form.slug=null},formatSlug:function(){if(angular.isDefined(a.form.title)){var b=d("limitTo")(a.form.title,30);a.form.slug=b.toLowerCase().replace(/ /g,"-").replace(/[^\w-]+/g,"")}},editSlug:function(){this.defaultSlug?this.defaultSlug=!1:(this.defaultSlug=!0,a.formatSlug())}})})}]),ss.factory("i18n",["$q","$cookies","objScan",function(a,b,c){var d=b.languageLocale?b.languageLocale:"en",e=function(){angular.extend(this,{locale:d,page:"global",store:{},langPack:null,set:function(a,b){c(this,a,b),1==a.split(".").length&&this.langPack&&this.update()},update:function(){var a=this.langPack[this.locale].global,c=this.langPack[this.locale][this.page];this.store=angular.extend({},a,c),b.languageLocale=this.locale}})};return new e}]).controller("i18nToggle",["$scope","i18n",function(a,b){a.languageOptions=[],angular.extend(a,{toggle:function(c){angular.forEach(a.languageOptions,function(a){a.active=!1}),c.active=!0,b.set("locale",c.locale)}}),angular.extend(this,{i18n:b,addOption:function(b){a.languageOptions.push(b)}})}]).directive("i18nToggle",function(){return{restrict:"E",transclude:!0,controller:"i18nToggle",template:'<ul class="languageToggle"><i18n-option title="English" locale="en"></i18n-option><i18n-option title="French" locale="fr"></i18n-option><li ng-repeat="option in languageOptions" ng-class="{active:option.active}"><a href="" ng-click="toggle(option)">{{option.title}}</a></li></ul>',replace:!0}}).directive("i18nOption",function(){return{restrict:"E",require:"^i18nToggle",scope:{locale:"@",title:"@"},link:function(a,b,c,d){d.addOption(a),c.locale==d.i18n.locale&&(a.active=!0),b.remove()}}}),ss.directive("notification",["$timeout",function(a){return{restrict:"E",transclude:!0,replace:!0,scope:{notify:"=property"},link:function(b){b.closeNotification=function(){delete b.notify},b.$watch("notify.timeout",function(c,d){c!==d&&"undefined"!=typeof c&&a(function(){delete b.notify},c)})},template:'<div ng-show="notify.state" class="notification notify.state">{{ notify.message }} <a href="" ng-click="closeNotification()">Close</a></div>'}}]),ss.controller("imageUploader",["$scope","api","$element","$controller",function(a,b,c,d){d("_Base",{$scope:angular.extend(a,{initialise:function(){this.$uploadInput=$("#uploader",c),console.log(this.$uploadInput)},uploading:!1,progress:0,image:null,"delete":function(c){b.upload.deleteFile(c).then(function(){a.image=null},function(b){a.$parent.notify={state:"error",message:b}})},upload:function(c){this.uploading||(this.uploading=!0,this.progress=0,angular.isArray(c)&&(c=c[0]),b.upload.image(c).progress(function(b){a.progress=Math.floor(b.loaded/b.total)}).success(function(b){a.image=b,a.uploading=!1,a.progress=0}).error(function(b){a.$parent.notify={state:"error",message:b},a.uploading=!1,a.image=null}))}})})}]).directive("imageUpload",function(){return{restrict:"E",transclude:!0,scope:{image:"="},controller:"imageUploader",templateUrl:"app/shared/uploaders/image.view.html",replace:!0}});var $head=$("head"),$body=$("body");ss.factory("hitch",[function(){return function(a,b){return Function.prototype.bind?b.bind(a):b.apply(a,arguments)}}]).factory("objScan",[function(){return function(a,b,c){for(props=b.split(".");props.length>1;)a=a[props.shift()];return c?a[props.shift()]=c:a[props.shift()]}}]);